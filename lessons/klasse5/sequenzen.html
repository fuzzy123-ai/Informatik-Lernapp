<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequenzen programmieren - Informatik Lernapp</title>
    <link rel="stylesheet" href="../../styles/main.css">
    <style>
        .command-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .command-card:active {
            cursor: grabbing;
        }
        .command-card:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        .command-icon {
            font-size: 2rem;
            min-width: 3rem;
            text-align: center;
        }
        .sequence-area {
            background: #f7fafc;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            min-height: 400px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .sequence-step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .step-number {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 1rem;
        }
        .robot-canvas {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            min-height: 400px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 0.5rem;
        }
        .grid-cell {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            aspect-ratio: 1;
        }
        .grid-cell.robot {
            background: #667eea;
            transform: scale(1.2);
            z-index: 10;
        }
        .grid-cell.goal {
            background: #48bb78;
        }
        .example-box {
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="lesson-header">
            <button class="btn btn-secondary" onclick="window.location.href='../../student-dashboard.html'">
                ‚Üê Zur√ºck zum Dashboard
            </button>
            <h1>‚û°Ô∏è Sequenzen programmieren</h1>
            <div class="lesson-info">
                <span class="badge">Klasse 5</span>
                <span class="badge badge-primary">Lektion 5/6</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('theory')">üìñ Theorie</button>
            <button class="tab-btn" onclick="switchTab('interactive')">üéÆ Interaktiv</button>
            <button class="tab-btn" onclick="switchTab('quiz')">‚úÖ Quiz</button>
        </div>

        <!-- Theory Tab -->
        <div id="theory" class="tab-content active">
            <div class="card">
                <h2>Was ist eine Sequenz?</h2>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin: 2rem 0;">
                    <h3 style="color: white;">üìù Definition</h3>
                    <p style="font-size: 1.2rem; line-height: 1.6;">
                        Eine <strong>Sequenz</strong> ist eine <strong>Abfolge von Befehlen</strong>, die <strong>nacheinander</strong> ausgef√ºhrt werden.<br>
                        <strong>Die Reihenfolge ist wichtig!</strong>
                    </p>
                </div>

                <h3>üéØ Alltagsbeispiele</h3>
                <div class="example-box">
                    <h4>ü•™ Sandwich machen</h4>
                    <ol style="font-size: 1.1rem; line-height: 1.8;">
                        <li><strong>Schritt 1:</strong> Brot holen</li>
                        <li><strong>Schritt 2:</strong> Butter auftragen</li>
                        <li><strong>Schritt 3:</strong> K√§se drauflegen</li>
                        <li><strong>Schritt 4:</strong> Zweite Scheibe drauf</li>
                    </ol>
                    <p style="color: #e53e3e; margin-top: 1rem;">
                        ‚ùå Falsche Reihenfolge ‚Üí <strong>Chaos!</strong><br>
                        (Butter auf K√§se? Zweite Scheibe zuerst?)
                    </p>
                </div>

                <div class="example-box">
                    <h4>üö∂ Zur Schule gehen</h4>
                    <ol style="font-size: 1.1rem; line-height: 1.8;">
                        <li><strong>Schritt 1:</strong> Aufstehen</li>
                        <li><strong>Schritt 2:</strong> Anziehen</li>
                        <li><strong>Schritt 3:</strong> Fr√ºhst√ºcken</li>
                        <li><strong>Schritt 4:</strong> Schuhe anziehen</li>
                        <li><strong>Schritt 5:</strong> Zur Schule laufen</li>
                    </ol>
                </div>

                <h3>üíª Sequenzen in der Programmierung</h3>
                <p>Computer f√ºhren Befehle <strong>immer in der Reihenfolge aus</strong>, wie du sie aufschreibst:</p>
                
                <div style="background: #2d3748; color: white; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; font-family: monospace;">
                    <div style="color: #48bb78;">// Beispiel: Roboter-Steuerung</div>
                    <div>1. gehe_vorw√§rts()</div>
                    <div>2. drehe_rechts()</div>
                    <div>3. gehe_vorw√§rts()</div>
                    <div>4. hebe_objekt_auf()</div>
                </div>

                <div style="background: #fff4e6; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #f59e0b;">‚ö†Ô∏è Wichtig zu wissen:</h4>
                    <ul>
                        <li>Jeder Befehl wird <strong>genau einmal</strong> ausgef√ºhrt</li>
                        <li>Befehle werden <strong>von oben nach unten</strong> abgearbeitet</li>
                        <li>Computer warten nicht - sie f√ºhren Befehle <strong>sofort nacheinander</strong> aus</li>
                        <li>Ein falscher Befehl an der falschen Stelle = <strong>Fehler!</strong></li>
                    </ul>
                </div>

                <h3>üé® Sequenzen in Scratch</h3>
                <p>In Scratch setzt du Bl√∂cke <strong>√ºbereinander</strong> - das ist deine Sequenz!</p>
                <div style="text-align: center; font-size: 3rem; margin: 2rem 0;">
                    ‚¨áÔ∏è<br>
                    üü° Wenn Flagge angeklickt<br>
                    ‚¨áÔ∏è<br>
                    üîµ Gehe 10 Schritte<br>
                    ‚¨áÔ∏è<br>
                    üü£ Sage "Hallo!"<br>
                    ‚¨áÔ∏è<br>
                    üîµ Drehe dich um 90¬∞
                </div>
            </div>
        </div>

        <!-- Interactive Tab -->
        <div id="interactive" class="tab-content">
            <div class="card">
                <h2>ü§ñ Roboter-Steuerung</h2>
                <p>Bringe den Roboter zum Ziel! Erstelle eine Sequenz von Befehlen:</p>

                <div class="grid grid-2">
                    <div>
                        <h3>üì¶ Verf√ºgbare Befehle</h3>
                        <div id="commandPalette">
                            <div class="command-card" draggable="true" ondragstart="dragCommand(event)" data-cmd="forward">
                                <div class="command-icon">‚¨ÜÔ∏è</div>
                                <div>
                                    <strong>Gehe vorw√§rts</strong><br>
                                    <small>1 Feld nach oben</small>
                                </div>
                            </div>
                            <div class="command-card" draggable="true" ondragstart="dragCommand(event)" data-cmd="right">
                                <div class="command-icon">‚û°Ô∏è</div>
                                <div>
                                    <strong>Gehe nach rechts</strong><br>
                                    <small>1 Feld nach rechts</small>
                                </div>
                            </div>
                            <div class="command-card" draggable="true" ondragstart="dragCommand(event)" data-cmd="down">
                                <div class="command-icon">‚¨áÔ∏è</div>
                                <div>
                                    <strong>Gehe nach unten</strong><br>
                                    <small>1 Feld nach unten</small>
                                </div>
                            </div>
                            <div class="command-card" draggable="true" ondragstart="dragCommand(event)" data-cmd="left">
                                <div class="command-icon">‚¨ÖÔ∏è</div>
                                <div>
                                    <strong>Gehe nach links</strong><br>
                                    <small>1 Feld nach links</small>
                                </div>
                            </div>
                        </div>

                        <h3 style="margin-top: 2rem;">üìù Deine Sequenz</h3>
                        <div id="sequenceArea" class="sequence-area" ondrop="dropCommand(event)" ondragover="allowDrop(event)">
                            <p style="color: #a0aec0; text-align: center;">Ziehe Befehle hierher...</p>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="executeSequence()">‚ñ∂Ô∏è Ausf√ºhren</button>
                            <button class="btn btn-danger" onclick="clearSequence()">üóëÔ∏è L√∂schen</button>
                            <button class="btn btn-secondary" onclick="resetRobot()">üîÑ Zur√ºcksetzen</button>
                        </div>
                    </div>

                    <div>
                        <h3>üéÆ Spielfeld</h3>
                        <div id="robotCanvas" class="robot-canvas"></div>
                        <div id="feedback" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üéØ Challenges</h2>
                <p>Versuche diese Aufgaben zu l√∂sen:</p>
                <div class="grid grid-3">
                    <button class="btn btn-primary" onclick="loadChallenge(1)">
                        Level 1: Einfach
                    </button>
                    <button class="btn btn-primary" onclick="loadChallenge(2)">
                        Level 2: Mittel
                    </button>
                    <button class="btn btn-primary" onclick="loadChallenge(3)">
                        Level 3: Schwer
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Tab -->
        <div id="quiz" class="tab-content">
            <div class="card">
                <h2>‚úÖ Wissenstest</h2>
                <div id="quizContainer"></div>
                <button id="checkBtn" class="btn btn-primary" onclick="checkQuiz()" style="display: none;">
                    Antworten √ºberpr√ºfen
                </button>
                <div id="quizResult"></div>
            </div>
        </div>

        <!-- Complete Button -->
        <div style="text-align: center; margin: 2rem 0;">
            <button class="btn btn-success btn-lg" onclick="completeLesson()">
                ‚úì Lektion abschlie√üen
            </button>
        </div>
    </div>

    <script src="../../js/auth.js"></script>
    <script src="../../js/progress.js"></script>
    <script>
        requireAuth();
        const lessonId = 'k5-05';
        
        let robotPos = { x: 0, y: 4 };
        let goalPos = { x: 4, y: 0 };
        let sequence = [];

        const quizQuestions = [
            {
                question: "Was ist eine Sequenz in der Programmierung?",
                options: [
                    "Eine zuf√§llige Anordnung von Befehlen",
                    "Eine Abfolge von Befehlen, die nacheinander ausgef√ºhrt werden",
                    "Ein Befehl, der sich wiederholt",
                    "Eine Fehlermeldung"
                ],
                correct: 1
            },
            {
                question: "Warum ist die Reihenfolge bei Sequenzen wichtig?",
                options: [
                    "Ist sie nicht - Computer machen alles gleichzeitig",
                    "Weil Computer die Befehle von oben nach unten ausf√ºhren",
                    "Nur aus optischen Gr√ºnden",
                    "Damit der Code schneller l√§uft"
                ],
                correct: 1
            },
            {
                question: "Wie oft wird jeder Befehl in einer Sequenz ausgef√ºhrt?",
                options: [
                    "So oft man will",
                    "Zweimal",
                    "Genau einmal",
                    "Unendlich oft"
                ],
                correct: 2
            },
            {
                question: "Was passiert, wenn ein Befehl in der falschen Reihenfolge steht?",
                options: [
                    "Nichts, Computer korrigieren das automatisch",
                    "Das Programm kann falsch ablaufen",
                    "Der Computer explodiert",
                    "Alles funktioniert trotzdem"
                ],
                correct: 1
            }
        ];

        function initRobotCanvas() {
            const canvas = document.getElementById('robotCanvas');
            canvas.innerHTML = '';
            
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `cell-${x}-${y}`;
                    
                    if (x === robotPos.x && y === robotPos.y) {
                        cell.classList.add('robot');
                        cell.textContent = 'ü§ñ';
                    }
                    if (x === goalPos.x && y === goalPos.y) {
                        cell.classList.add('goal');
                        cell.textContent = 'üéØ';
                    }
                    
                    canvas.appendChild(cell);
                }
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'interactive') initRobotCanvas();
            if (tabName === 'quiz') loadQuiz();
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function dragCommand(ev) {
            ev.dataTransfer.setData("command", ev.target.getAttribute('data-cmd'));
        }

        function dropCommand(ev) {
            ev.preventDefault();
            const cmd = ev.dataTransfer.getData("command");
            if (!cmd) return;
            
            sequence.push(cmd);
            renderSequence();
        }

        function renderSequence() {
            const area = document.getElementById('sequenceArea');
            if (sequence.length === 0) {
                area.innerHTML = '<p style="color: #a0aec0; text-align: center;">Ziehe Befehle hierher...</p>';
                return;
            }
            
            const icons = { forward: '‚¨ÜÔ∏è', right: '‚û°Ô∏è', down: '‚¨áÔ∏è', left: '‚¨ÖÔ∏è' };
            const names = { 
                forward: 'Gehe vorw√§rts', 
                right: 'Gehe nach rechts', 
                down: 'Gehe nach unten', 
                left: 'Gehe nach links' 
            };
            
            area.innerHTML = sequence.map((cmd, i) => `
                <div class="sequence-step">
                    <div style="display: flex; align-items: center;">
                        <span class="step-number">${i + 1}</span>
                        <span style="font-size: 1.5rem; margin-right: 1rem;">${icons[cmd]}</span>
                        <span>${names[cmd]}</span>
                    </div>
                    <button onclick="removeStep(${i})" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚úï</button>
                </div>
            `).join('');
        }

        function removeStep(index) {
            sequence.splice(index, 1);
            renderSequence();
        }

        function clearSequence() {
            sequence = [];
            renderSequence();
        }

        function resetRobot() {
            robotPos = { x: 0, y: 4 };
            initRobotCanvas();
            document.getElementById('feedback').style.display = 'none';
        }

        async function executeSequence() {
            if (sequence.length === 0) {
                alert('‚ö†Ô∏è F√ºge erst Befehle hinzu!');
                return;
            }

            resetRobot();
            
            for (let cmd of sequence) {
                await sleep(500);
                
                const oldCell = document.getElementById(`cell-${robotPos.x}-${robotPos.y}`);
                oldCell.classList.remove('robot');
                oldCell.textContent = '';
                
                switch(cmd) {
                    case 'forward': robotPos.y = Math.max(0, robotPos.y - 1); break;
                    case 'down': robotPos.y = Math.min(4, robotPos.y + 1); break;
                    case 'right': robotPos.x = Math.min(4, robotPos.x + 1); break;
                    case 'left': robotPos.x = Math.max(0, robotPos.x - 1); break;
                }
                
                const newCell = document.getElementById(`cell-${robotPos.x}-${robotPos.y}`);
                newCell.classList.add('robot');
                newCell.textContent = 'ü§ñ';
            }
            
            await sleep(300);
            checkGoal();
        }

        function checkGoal() {
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';
            
            if (robotPos.x === goalPos.x && robotPos.y === goalPos.y) {
                feedback.style.background = '#f0fff4';
                feedback.style.border = '2px solid #48bb78';
                feedback.innerHTML = '<h3 style="color: #48bb78;">üéâ Geschafft! Du hast das Ziel erreicht!</h3>';
            } else {
                feedback.style.background = '#fff5f5';
                feedback.style.border = '2px solid #f56565';
                feedback.innerHTML = '<h3 style="color: #f56565;">‚ùå Noch nicht am Ziel! Versuche es nochmal.</h3>';
            }
        }

        function loadChallenge(level) {
            clearSequence();
            resetRobot();
            
            const challenges = {
                1: { robot: {x: 0, y: 4}, goal: {x: 2, y: 2} },
                2: { robot: {x: 0, y: 0}, goal: {x: 4, y: 4} },
                3: { robot: {x: 2, y: 2}, goal: {x: 0, y: 4} }
            };
            
            robotPos = challenges[level].robot;
            goalPos = challenges[level].goal;
            initRobotCanvas();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function loadQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = quizQuestions.map((q, index) => `
                <div class="quiz-question" style="margin-bottom: 2rem; padding: 1.5rem; background: #f7fafc; border-radius: 8px;">
                    <h3 style="color: #2d3748; margin-bottom: 1rem;">Frage ${index + 1}: ${q.question}</h3>
                    ${q.options.map((option, i) => `
                        <label style="display: block; padding: 0.75rem; margin: 0.5rem 0; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #e2e8f0;">
                            <input type="radio" name="question${index}" value="${i}" style="margin-right: 0.5rem;">
                            ${option}
                        </label>
                    `).join('')}
                </div>
            `).join('');
            
            document.getElementById('checkBtn').style.display = 'block';
        }

        function checkQuiz() {
            let correctCount = 0;
            quizQuestions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                if (selected && parseInt(selected.value) === q.correct) correctCount++;
            });
            
            const percentage = Math.round((correctCount / quizQuestions.length) * 100);
            const passed = percentage >= 60;
            
            document.getElementById('quizResult').innerHTML = `
                <div style="margin-top: 2rem; padding: 2rem; background: ${passed ? '#f0fff4' : '#fff5f5'}; border-radius: 12px; border: 2px solid ${passed ? '#48bb78' : '#f56565'};">
                    <h3 style="color: ${passed ? '#48bb78' : '#f56565'}; font-size: 1.5rem; margin-bottom: 1rem;">
                        ${passed ? 'üéâ Bestanden!' : '‚ùå Noch nicht bestanden'}
                    </h3>
                    <p style="font-size: 1.2rem;">Du hast <strong>${correctCount} von ${quizQuestions.length}</strong> Fragen richtig beantwortet.</p>
                    <p style="font-size: 1.5rem; font-weight: bold; color: ${passed ? '#48bb78' : '#f56565'};">Ergebnis: ${percentage}%</p>
                </div>
            `;
            
            if (passed) setTimeout(() => markLessonCompleted(getCurrentToken(), lessonId, percentage), 1000);
        }

        function completeLesson() {
            if (confirm('M√∂chtest du diese Lektion als abgeschlossen markieren?')) {
                markLessonCompleted(getCurrentToken(), lessonId, 100);
                alert('üéâ Lektion abgeschlossen!');
                window.location.href = '../../student-dashboard.html';
            }
        }

        initRobotCanvas();
        markLessonInProgress(getCurrentToken(), lessonId);
    </script>
</body>
</html>
